# Инструкция по созданию шаблонов задач в Planfix

## Обзор

Система автоматически выбирает шаблон задачи в Planfix в зависимости от:
- **Типа заявки**: Консультация или Обратный звонок
- **Услуги**: AI-аудит, Proof of Concept, Интеграции под ключ, Поддержка 24/7

## Структура шаблонов

### 1. Консультации (с указанием услуги)

#### 1.1. Консультация: AI-аудит
- **Переменная окружения**: `PLANFIX_TEMPLATE_CONSULTATION_AI_AUDIT`
- **Когда используется**: Заявка типа "Консультация" с услугой "AI-аудит"

#### 1.2. Консультация: Proof of Concept
- **Переменная окружения**: `PLANFIX_TEMPLATE_CONSULTATION_POC`
- **Когда используется**: Заявка типа "Консультация" с услугой "Proof of Concept"

#### 1.3. Консультация: Интеграции под ключ
- **Переменная окружения**: `PLANFIX_TEMPLATE_CONSULTATION_TURNKEY`
- **Когда используется**: Заявка типа "Консультация" с услугой "Интеграции под ключ"

#### 1.4. Консультация: Поддержка 24/7
- **Переменная окружения**: `PLANFIX_TEMPLATE_CONSULTATION_SUPPORT`
- **Когда используется**: Заявка типа "Консультация" с услугой "Поддержка 24/7"

### 2. Консультация (общий шаблон)

- **Переменная окружения**: `PLANFIX_TEMPLATE_CONSULTATION`
- **Когда используется**: Заявка типа "Консультация" без указания услуги или если специфичный шаблон не настроен

### 3. Обратный звонок

- **Переменная окружения**: `PLANFIX_TEMPLATE_CALLBACK`
- **Когда используется**: Заявка типа "Обратный звонок"

## Как создать шаблон в Planfix

### Шаг 1: Создание шаблона задачи

1. Войдите в Planfix
2. Перейдите в **Настройки** → **Шаблоны задач**
3. Нажмите **Создать шаблон**
4. Заполните поля:

#### Для консультаций (пример для AI-аудит):

**Название шаблона**: `Консультация: AI-аудит`

**Поля шаблона** (рекомендуемые):

1. **Название задачи** (обязательно):
   ```
   Консультация с сайта: {Имя клиента}
   ```

2. **Описание задачи**:
   ```
   Новая заявка с сайта

   Тип заявки: Консультация
   Имя: {Имя}
   Email: {Email}
   Телефон: {Телефон}
   Интересующая услуга: AI-аудит
   
   Задача:
   {Описание задачи}
   ```

3. **Ответственный**: Назначьте менеджера по продажам

4. **Проект**: Укажите проект "Заявки с сайта" (если используется)

5. **Приоритет**: Средний или Высокий

6. **Срок выполнения**: 1 рабочий день

7. **Теги**: `консультация`, `ai-аудит`, `заявка-с-сайта`

8. **Поля-списки** (если используются):
   - **Источник**: Сайт
   - **Тип заявки**: Консультация
   - **Услуга**: AI-аудит

#### Для обратного звонка:

**Название шаблона**: `Обратный звонок`

**Поля шаблона**:

1. **Название задачи**:
   ```
   Обратный звонок с сайта: {Имя клиента}
   ```

2. **Описание задачи**:
   ```
   Запрос обратного звонка

   Имя: {Имя}
   Телефон: {Телефон}
   ```

3. **Ответственный**: Менеджер по продажам

4. **Срок выполнения**: Сегодня

5. **Теги**: `обратный-звонок`, `заявка-с-сайта`

### Шаг 2: Получение ID шаблона

1. Откройте созданный шаблон в Planfix
2. Посмотрите в URL браузера — ID шаблона будет в адресе
   - Пример: `https://ваш-аккаунт.planfix.ru/template/12345`
   - ID шаблона: `12345`

Или используйте API Planfix для получения списка шаблонов:
```bash
curl -X GET "https://ваш-аккаунт.planfix.ru/rest/template/list" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

### Шаг 3: Настройка переменных окружения

Добавьте ID шаблонов в файл `.env.local`:

```bash
# Шаблоны для консультаций
PLANFIX_TEMPLATE_CONSULTATION_AI_AUDIT=12345
PLANFIX_TEMPLATE_CONSULTATION_POC=12346
PLANFIX_TEMPLATE_CONSULTATION_TURNKEY=12347
PLANFIX_TEMPLATE_CONSULTATION_SUPPORT=12348
PLANFIX_TEMPLATE_CONSULTATION=12349  # Общий шаблон для консультаций

# Шаблон для обратных звонков
PLANFIX_TEMPLATE_CALLBACK=12350
```

### Шаг 4: Перезапуск сервиса

После добавления переменных окружения перезапустите сервис:

```bash
sudo systemctl restart vibecoding
```

## Логика выбора шаблона

Система выбирает шаблон в следующем порядке:

1. **Если тип заявки = "Консультация" и указана услуга**:
   - Ищет специфичный шаблон (например, `PLANFIX_TEMPLATE_CONSULTATION_AI_AUDIT`)
   - Если не найден → использует общий шаблон консультаций

2. **Если тип заявки = "Обратный звонок"**:
   - Использует шаблон `PLANFIX_TEMPLATE_CALLBACK`

3. **Если шаблон не найден**:
   - Задача создается без шаблона (только с названием и описанием)

## Рекомендации по настройке шаблонов

### Для консультаций:

- **Автоматическое назначение**: Назначьте ответственного менеджера
- **Уведомления**: Настройте уведомления для ответственного
- **Автоматические действия**: 
  - Создание контакта (если его нет)
  - Добавление в воронку продаж
  - Установка статуса "Новая заявка"

### Для обратных звонков:

- **Срочность**: Установите высокий приоритет
- **Срок**: Сегодня или "Срочно"
- **Уведомления**: SMS или push-уведомление менеджеру

## Проверка работы

После настройки проверьте:

1. Отправьте тестовую заявку "Консультация" с услугой "AI-аудит"
2. Проверьте в Planfix, что задача создана с правильным шаблоном
3. Убедитесь, что все поля заполнены корректно

## Отладка

Если шаблоны не применяются, проверьте логи:

```bash
sudo journalctl -u vibecoding -f
```

Ищите строки:
- `[CONTACT] Template selected: ...`
- `[CONTACT] Template ID: ...`

## Дополнительные поля

Если в Planfix используются дополнительные поля (списки, даты, числа), их можно добавить в шаблон. Система автоматически заполнит только базовые поля:
- Название задачи
- Описание задачи

Для заполнения дополнительных полей потребуется расширение API интеграции.

